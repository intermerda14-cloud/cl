<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BB Scalper V4.2 Dashboard</title>
    <!-- TradingView Lightweight Charts - LOAD ASYNC -->
    <script>
        // Show immediate loading screen
        document.addEventListener('DOMContentLoaded', function() {
            // IMMEDIATE: Show chart is loading
            document.getElementById('tv-chart').innerHTML = `
                <div style="
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    height: 100%;
                    color: #00ff88;
                    text-align: center;
                ">
                    <div style="font-size: 48px; margin-bottom: 20px;">âš¡</div>
                    <h3>LOADING TRADINGVIEW CHART ENGINE</h3>
                    <p style="color: #888; margin-top: 10px;">Please wait 2-3 seconds...</p>
                    <div style="
                        width: 200px;
                        height: 4px;
                        background: rgba(255,255,255,0.1);
                        border-radius: 2px;
                        margin-top: 20px;
                        overflow: hidden;
                    ">
                        <div id="chartLoadingBar" style="
                            width: 0%;
                            height: 100%;
                            background: linear-gradient(90deg, #00ff88, #ffd700);
                            border-radius: 2px;
                            transition: width 0.3s;
                        "></div>
                    </div>
                </div>
            `;
            
            // Animate loading bar
            let progress = 0;
            const bar = document.getElementById('chartLoadingBar');
            const interval = setInterval(() => {
                progress += 10;
                bar.style.width = progress + '%';
                if (progress >= 100) clearInterval(interval);
            }, 200);
            
            // Load TradingView ASYNC
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js';
            script.async = true;
            script.onload = function() {
                console.log('âœ… TradingView library loaded');
                initializeTradingViewChart();
                // Start data fetching IMMEDIATELY
                initializeDashboard();
            };
            document.head.appendChild(script);
            
            // Start minimal functions immediately
            updateServerTime();
            setInterval(updateServerTime, 1000);
        });
    </script>
    <style>
        /* CSS SAMA PERSIS seperti sebelumnya */
        /* ... */
    </style>
</head>
<body>
    <!-- HEADER SAMA -->
    <div class="header">
        <div class="logo">ðŸ“ˆ BB SCALPER <span>V4.2 PRO</span></div>
        <div class="status-bar">
            <div class="status-item" id="connectionBox">
                <span class="dot" id="statusDot"></span>
                <span id="connectionStatus">LOADING</span>
            </div>
            <div class="status-item">ACTIVE: <span id="activeCount">0</span></div>
            <div class="status-item">EQUITY: <span id="headerEquity">$0</span></div>
            <div class="status-item"><span id="serverTime">--:--:--</span></div>
        </div>
    </div>
    
    <div class="container">
        <div class="chart-section">
            <div class="chart-header">
                <div class="symbol-title">
                    <span id="chartSymbol">--</span>
                    <span class="price" id="chartPrice">$0.00</span>
                </div>
                <div class="chart-controls">
                    <select id="timeframeSelect">
                        <option value="1">1 Minute</option>
                        <option value="5">5 Minutes</option>
                        <option value="15">15 Minutes</option>
                        <option value="30">30 Minutes</option>
                        <option value="60">1 Hour</option>
                        <option value="240">4 Hours</option>
                    </select>
                    <button onclick="refreshChart()">ðŸ”„ REFRESH</button>
                    <span style="color: #888;">|</span>
                    <span id="chartSpread" style="color: #aaa;">Spread: --</span>
                    <span id="chartVol" style="color: #ffd700;">Vol: --</span>
                </div>
            </div>
            
            <!-- CHART CONTAINER - Loading screen will be shown here -->
            <div id="chartContainer">
                <div id="tv-chart"></div>
            </div>
        </div>
        
        <!-- SIDEBAR SAMA -->
        <div class="sidebar">
            <!-- ... sama seperti sebelumnya ... -->
        </div>
    </div>
    
    <div class="footer">
        BB Scalper V4.2 | TradingView Lightweight Charts | Fast Loading v2
    </div>
    
    <script>
        // Configuration - LOAD IMMEDIATELY
        const API_BASE = '/api/';
        const REFRESH_INTERVAL = 3000;
        
        // Global variables
        let tvChart = null;
        let candleSeries = null;
        let currentSymbol = null;
        let isConnected = false;
        
        // ========== IMMEDIATE FUNCTIONS ==========
        function updateServerTime() {
            const time = new Date().toLocaleTimeString('en-US', { hour12: false });
            if (document.getElementById('serverTime')) {
                document.getElementById('serverTime').textContent = time;
            }
        }
        
        // ========== FAST INITIALIZATION ==========
        function initializeDashboard() {
            console.log('ðŸš€ Fast dashboard initialization');
            
            // Update status
            document.getElementById('connectionStatus').textContent = 'CHECKING DATA';
            
            // Setup timeframe selector
            document.getElementById('timeframeSelect').addEventListener('change', function() {
                if (currentSymbol) {
                    fetchChartData(currentSymbol);
                }
            });
            
            // IMMEDIATE data check
            fetchData();
            
            // Start auto-refresh
            setInterval(fetchData, REFRESH_INTERVAL);
        }
        
        // ========== TRADINGVIEW CHART - Load setelah library ready ==========
        function initializeTradingViewChart() {
            try {
                const chartContainer = document.getElementById('tv-chart');
                
                // Clear loading screen
                chartContainer.innerHTML = '';
                
                tvChart = LightweightCharts.createChart(chartContainer, {
                    width: chartContainer.clientWidth,
                    height: chartContainer.clientHeight,
                    layout: { backgroundColor: '#0c0c14', textColor: '#e0e0ff' },
                    grid: { vertLines: { color: '#1a1a2a' }, horzLines: { color: '#1a1a2a' } },
                    crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
                    rightPriceScale: { borderColor: '#1a1a2a' },
                    timeScale: { borderColor: '#1a1a2a', timeVisible: true },
                });
                
                candleSeries = tvChart.addCandlestickSeries({
                    upColor: '#00ff88',
                    downColor: '#ff4444',
                    borderUpColor: '#00cc66',
                    borderDownColor: '#cc0000',
                    wickUpColor: '#00cc66',
                    wickDownColor: '#cc0000',
                });
                
                // Resize handler
                window.addEventListener('resize', () => {
                    tvChart.applyOptions({
                        width: chartContainer.clientWidth,
                        height: chartContainer.clientHeight,
                    });
                });
                
                console.log('âœ… TradingView Chart READY');
                
            } catch (error) {
                console.error('âŒ Chart init error:', error);
            }
        }
        
        // ========== UPDATE CHART ==========
        function updateTradingViewChart(candlestickData, symbol) {
            if (!candleSeries || !candlestickData || candlestickData.length === 0) return;
            
            const tvData = candlestickData.map(candle => ({
                time: Math.floor(candle.t),
                open: candle.o,
                high: candle.h,
                low: candle.l,
                close: candle.c,
            }));
            
            candleSeries.setData(tvData);
            tvChart.timeScale().fitContent();
            
            console.log(`ðŸ“ˆ Chart updated: ${tvData.length} candles`);
        }
        
        // ========== DATA FETCHING ==========
        async function fetchData() {
            try {
                console.log('ðŸ”„ Checking data...');
                const response = await fetch(API_BASE + 'data');
                const data = await response.json();
                
                if (data.status === 'ok' && data.active_count > 0) {
                    updateDashboard(data);
                    setConnected();
                    
                    if (currentSymbol) {
                        fetchChartData(currentSymbol);
                    }
                } else {
                    setDisconnected();
                }
                
            } catch (error) {
                console.error('Fetch error:', error);
                setDisconnected();
            }
        }
        
        async function fetchChartData(symbol) {
            if (!symbol) return;
            
            try {
                const response = await fetch(`${API_BASE}chart?symbol=${symbol}`);
                const data = await response.json();
                
                if (data.status === 'ok' && data.data) {
                    updateTradingViewChart(data.data, symbol);
                }
                
            } catch (error) {
                console.error('Chart error:', error);
            }
        }
        
        // ========== DASHBOARD UPDATE ==========
        function updateDashboard(data) {
            const symbols = data.symbols || {};
            const symbolKeys = Object.keys(symbols);
            
            document.getElementById('activeCount').textContent = symbolKeys.length;
            
            if (symbolKeys.length > 0) {
                if (!currentSymbol || !symbols[currentSymbol]) {
                    currentSymbol = symbolKeys[0];
                }
                
                if (currentSymbol && symbols[currentSymbol]) {
                    updateSymbolData(symbols[currentSymbol]);
                }
                
                updateSymbolList(symbols);
            }
        }
        
        function updateSymbolData(d) {
            // Update UI fields
            document.getElementById('chartSymbol').textContent = d.symbol || '--';
            document.getElementById('chartPrice').textContent = '$' + (d.bid || 0).toFixed(2);
            // ... (sama seperti sebelumnya)
        }
        
        function updateSymbolList(symbols) {
            const list = document.getElementById('symbolList');
            const keys = Object.keys(symbols);
            
            if (keys.length === 0) return;
            
            list.innerHTML = keys.map(sym => `
                <div class="symbol-item ${sym === currentSymbol ? 'active' : ''}" onclick="selectSymbol('${sym}')">
                    <span>${sym}</span>
                    <span style="color: #00ff88; font-weight: bold;">
                        $${(symbols[sym].bid || 0).toFixed(2)}
                    </span>
                </div>
            `).join('');
        }
        
        function selectSymbol(symbol) {
            currentSymbol = symbol;
            fetchData();
        }
        
        function refreshChart() {
            if (currentSymbol) fetchChartData(currentSymbol);
        }
        
        function setConnected() {
            if (!isConnected) {
                isConnected = true;
                document.getElementById('connectionStatus').textContent = 'CONNECTED';
                document.getElementById('connectionBox').className = 'status-item connected';
                document.getElementById('statusDot').className = 'dot green';
            }
        }
        
        function setDisconnected() {
            isConnected = false;
            document.getElementById('connectionStatus').textContent = 'WAITING';
            document.getElementById('connectionBox').className = 'status-item disconnected';
            document.getElementById('statusDot').className = 'dot red';
        }
    </script>
</body>
</html>
