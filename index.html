<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BB Scalper V4.2 Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@latest/dist/chartjs-chart-financial.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, sans-serif; 
            background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #16213e 100%);
            color: #fff; 
            min-height: 100vh;
        }
        .header {
            background: rgba(0,0,0,0.3);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .logo { font-size: 24px; font-weight: bold; color: #ffd700; }
        .logo span { color: #00ff88; }
        .status-bar { display: flex; gap: 20px; flex-wrap: wrap; }
        .status-item {
            background: rgba(255,255,255,0.1);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
        }
        .status-item.connected { border: 1px solid #00ff88; }
        .status-item.disconnected { border: 1px solid #ff4444; }
        .status-item .dot { 
            display: inline-block; 
            width: 8px; height: 8px; 
            border-radius: 50%; 
            margin-right: 6px;
            animation: pulse 2s infinite;
        }
        .dot.green { background: #00ff88; }
        .dot.red { background: #ff4444; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .container { 
            display: grid; 
            grid-template-columns: 1fr 350px; 
            gap: 20px; 
            padding: 20px; 
            max-width: 1800px;
            margin: 0 auto;
        }
        .chart-section {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .chart-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .symbol-title { font-size: 20px; font-weight: bold; }
        .symbol-title .price { color: #00ff88; margin-left: 15px; }
        .chart-container { height: 500px; position: relative; }
        .waiting {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 300px;
            color: #ffd700;
            text-align: center;
            padding: 20px;
        }
        .waiting .icon { font-size: 48px; margin-bottom: 20px; }
        .info-box {
            background: rgba(0,0,0,0.5);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-size: 12px;
            text-align: left;
            max-width: 600px;
            border-left: 3px solid #ffd700;
        }
        select, button {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid #00ff88;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        select:hover, button:hover {
            background: rgba(0,255,136,0.2);
        }
        .sidebar { display: flex; flex-direction: column; gap: 15px; }
        .card {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .card-title {
            font-size: 12px;
            text-transform: uppercase;
            color: #888;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .equity { font-size: 36px; font-weight: bold; margin-bottom: 15px; }
        .equity.positive { color: #00ff88; }
        .equity.negative { color: #ff4444; }
        .account-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .account-row:last-child { border: none; }
        .account-label { color: #888; }
        .account-value.positive { color: #00ff88; }
        .account-value.negative { color: #ff4444; }
        .symbol-list { display: flex; flex-direction: column; gap: 10px; }
        .symbol-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .symbol-item:hover { background: rgba(255,255,255,0.1); }
        .symbol-item.active { border: 1px solid #ffd700; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stat-item { text-align: center; }
        .stat-value { font-size: 24px; font-weight: bold; color: #00ff88; }
        .stat-label { font-size: 11px; color: #888; margin-top: 5px; }
        .tier-row { display: flex; justify-content: space-around; margin-top: 15px; }
        .tier-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            background: rgba(255,255,255,0.1);
        }
        .tier-badge.active { background: #00ff88; color: #000; }
        .ml-confidence { text-align: center; padding: 20px; }
        .ml-value { font-size: 48px; font-weight: bold; }
        .ml-value.high { color: #00ff88; }
        .ml-value.medium { color: #ffd700; }
        .ml-value.low { color: #ff4444; }
        .ml-label { color: #888; margin-top: 10px; }
        .footer { text-align: center; padding: 20px; color: #555; font-size: 12px; }
        .test-btn {
            background: #00ff88;
            color: #000;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 15px;
        }
        .test-btn:hover { background: #00cc66; }
        @media (max-width: 1200px) {
            .container { grid-template-columns: 1fr; }
            .sidebar { display: grid; grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            .sidebar { grid-template-columns: 1fr; }
            .header { flex-direction: column; gap: 15px; }
            .chart-header { flex-direction: column; align-items: flex-start; }
            .chart-controls { width: 100%; justify-content: space-between; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">ü§ñ BB SCALPER <span>V4.2</span></div>
        <div class="status-bar">
            <div class="status-item" id="connectionBox">
                <span class="dot" id="statusDot"></span>
                <span id="connectionStatus">Connecting...</span>
            </div>
            <div class="status-item">üìä Active: <span id="activeCount">0</span></div>
            <div class="status-item">üí∞ Equity: <span id="headerEquity">$0</span></div>
            <div class="status-item">üïê <span id="serverTime">--:--:--</span></div>
        </div>
    </div>
    
    <div class="container">
        <div class="chart-section">
            <div class="chart-header">
                <div class="symbol-title">
                    <span id="chartSymbol">--</span>
                    <span class="price" id="chartPrice">$0.00</span>
                </div>
                <div class="chart-controls">
                    <select id="timeframeSelect">
                        <option value="M1">M1</option>
                        <option value="M5">M5</option>
                        <option value="M15">M15</option>
                        <option value="M30" selected>M30</option>
                        <option value="H1">H1</option>
                        <option value="H4">H4</option>
                    </select>
                    <button onclick="refreshChart()">üîÑ Refresh</button>
                    <span id="chartSpread">Spread: --</span>
                    <span id="chartVol">Vol: --</span>
                    <span id="chartTime">--:--:--</span>
                </div>
            </div>
            
            <div id="waitingState" class="waiting">
                <!-- Content will be loaded here -->
            </div>
            
            <div id="chartContainer" class="chart-container" style="display: none;">
                <canvas id="priceChart"></canvas>
            </div>
        </div>
        
        <div class="sidebar">
            <div class="card">
                <div class="card-title">üí∞ Account Summary</div>
                <div class="equity" id="equity">$0.00</div>
                <div class="account-row">
                    <span class="account-label">Balance</span>
                    <span class="account-value" id="balance">$0.00</span>
                </div>
                <div class="account-row">
                    <span class="account-label">Today P/L</span>
                    <span class="account-value" id="dailyPnl">$0.00</span>
                </div>
                <div class="account-row">
                    <span class="account-label">Floating</span>
                    <span class="account-value" id="floating">$0.00</span>
                </div>
                <div class="account-row">
                    <span class="account-label">Commission</span>
                    <span class="account-value" id="commission">$0.00</span>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">üìä Active Symbols</div>
                <div class="symbol-list" id="symbolList">
                    <div style="color: #888; text-align: center; padding: 20px;">No active symbols</div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">üìà Performance</div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="totalTrades">0</div>
                        <div class="stat-label">Total Trades</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="winRate">0%</div>
                        <div class="stat-label">Win Rate</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="wins">0</div>
                        <div class="stat-label">Wins</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="losses">0</div>
                        <div class="stat-label">Losses</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">üéØ Stats & Tiers</div>
                <div class="account-row">
                    <span class="account-label">Sharpe Ratio</span>
                    <span class="account-value" id="sharpe">0.00</span>
                </div>
                <div class="account-row">
                    <span class="account-label">Profit Factor</span>
                    <span class="account-value" id="profitFactor">0.00</span>
                </div>
                <div class="account-row">
                    <span class="account-label">Expectancy</span>
                    <span class="account-value" id="expectancy">$0.00</span>
                </div>
                <div class="tier-row">
                    <span class="tier-badge" id="tier1">T1: 0</span>
                    <span class="tier-badge" id="tier2">T2: 0</span>
                    <span class="tier-badge" id="tier3">T3: 0</span>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">ü§ñ ML Engine</div>
                <div class="ml-confidence">
                    <div class="ml-value" id="mlConfidence">--%</div>
                    <div class="ml-label">Confidence Score</div>
                </div>
                <div class="account-row">
                    <span class="account-label">Confluence</span>
                    <span class="account-value" id="confluence">--</span>
                </div>
                <div class="account-row">
                    <span class="account-label">Pattern</span>
                    <span class="account-value" id="pattern">--</span>
                </div>
                <div class="account-row">
                    <span class="account-label">Volatility</span>
                    <span class="account-value" id="volatility">--</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="footer">
        BB Scalper V4.2 Ultimate Pro | Vercel Edition | Auto-refresh 3s | Candlestick Charts
    </div>
    
    <script>
        // Configuration
        const API_BASE = '/api/';
        const REFRESH_INTERVAL = 3000; // 3 seconds
        
        let chart = null;
        let currentSymbol = null;
        let isConnected = false;
        let lastChartUpdate = 0;
        
        // Start when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ BB Scalper V4.2 Dashboard Starting...');
            
            // Update server time
            updateServerTime();
            setInterval(updateServerTime, 1000);
            
            // Setup timeframe selector
            document.getElementById('timeframeSelect').addEventListener('change', function() {
                console.log('üìä Timeframe changed to:', this.value);
                if (currentSymbol) {
                    fetchChartData(currentSymbol);
                }
            });
            
            // Show initial message
            showWaitingMessage('initial');
            
            // Start data fetching
            fetchData();
            setInterval(fetchData, REFRESH_INTERVAL);
        });
        
        function updateServerTime() {
            const time = new Date().toLocaleTimeString('en-US', { hour12: false });
            document.getElementById('serverTime').textContent = time;
            document.getElementById('chartTime').textContent = time;
        }
        
        function refreshChart() {
            if (currentSymbol) {
                console.log('üîÑ Manually refreshing chart for:', currentSymbol);
                fetchChartData(currentSymbol);
            }
        }
        
        // ========== MAIN DATA FETCH ==========
        async function fetchData() {
            try {
                console.log('üîÑ Fetching EA data...');
                
                const response = await fetch(API_BASE + 'data');
                const data = await response.json();
                
                console.log('üìä Server response:', data);
                
                if (data.status === 'ok') {
                    if (data.active_count > 0) {
                        console.log('‚úÖ EA data found! Symbols:', Object.keys(data.symbols));
                        updateDashboard(data);
                        setConnected();
                        
                        // Fetch chart data jika belum ada atau perlu update
                        if (currentSymbol && (!chart || Date.now() - lastChartUpdate > 10000)) {
                            fetchChartData(currentSymbol);
                        }
                    } else {
                        console.log('‚è≥ Waiting for EA data...');
                        showWaitingMessage('no_data');
                        setDisconnected();
                    }
                } else {
                    console.error('Server error:', data.message);
                    showWaitingMessage('error');
                    setDisconnected();
                }
                
            } catch (error) {
                console.error('‚ùå Network error:', error);
                showWaitingMessage('error');
                setDisconnected();
            }
        }
        
        // ========== CHART DATA FETCH ==========
        async function fetchChartData(symbol) {
            if (!symbol) return;
            
            const timeframe = document.getElementById('timeframeSelect').value;
            console.log(`üìà Fetching ${timeframe} chart for:`, symbol);
            
            try {
                const response = await fetch(`${API_BASE}chart?symbol=${symbol}&timeframe=${timeframe}`);
                const data = await response.json();
                
                console.log('üìä Chart response:', data);
                
                if (data.status === 'ok' && data.data && data.data.length > 0) {
                    console.log(`‚úÖ Found ${data.data.length} candles for ${data.timeframe}`);
                    updateChart(data.data, symbol, data.timeframe);
                    lastChartUpdate = Date.now();
                } else {
                    console.log('‚ö†Ô∏è No chart data, creating placeholder');
                    createPlaceholderChart(symbol);
                }
                
            } catch (error) {
                console.error('‚ùå Chart fetch error:', error);
                createPlaceholderChart(symbol);
            }
        }
        
        // ========== CREATE PLACEHOLDER CHART ==========
        function createPlaceholderChart(symbol) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            if (chart) {
                chart.destroy();
            }
            
            // Create placeholder candlestick data
            const placeholderData = [];
            const now = Date.now();
            let price = 100;
            
            for (let i = 60; i >= 0; i--) {
                const time = new Date(now - i * 60000);
                const open = price;
                const high = open + Math.random() * 2;
                const low = open - Math.random() * 2;
                const close = low + Math.random() * (high - low);
                
                placeholderData.push({
                    x: time,
                    o: open,
                    h: high,
                    l: low,
                    c: close
                });
                
                price = close;
            }
            
            chart = new Chart(ctx, {
                type: 'candlestick',
                data: {
                    datasets: [{
                        label: `${symbol} - Waiting for EA Chart Data`,
                        data: placeholderData,
                        color: {
                            up: '#00ff88',
                            down: '#ff4444',
                            unchanged: '#999'
                        },
                        borderColor: '#333',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: '‚ö° Waiting for EA Candlestick Data',
                            color: '#ffd700',
                            font: { size: 14 }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'minute' },
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#888', maxTicksLimit: 8 }
                        },
                        y: {
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { 
                                color: '#888',
                                callback: function(value) {
                                    return '$' + value.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // ========== UPDATE CANDLESTICK CHART ==========
        function updateChart(chartData, symbol, timeframe) {
            if (!chartData || !Array.isArray(chartData) || chartData.length === 0) {
                createPlaceholderChart(symbol);
                return;
            }
            
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            // Convert to candlestick format
            const financialData = chartData.map(item => ({
                x: new Date(item.t * 1000),
                o: parseFloat(item.o) || 0,
                h: parseFloat(item.h) || 0,
                l: parseFloat(item.l) || 0,
                c: parseFloat(item.c) || 0
            }));
            
            // Update timeframe selector
            document.getElementById('timeframeSelect').value = timeframe || 'M1';
            
            if (chart) {
                chart.data.datasets[0].data = financialData;
                chart.data.datasets[0].label = `${symbol} (${timeframe})`;
                chart.update('none');
            } else {
                // Create new candlestick chart
                chart = new Chart(ctx, {
                    type: 'candlestick',
                    data: {
                        datasets: [{
                            label: `${symbol} (${timeframe})`,
                            data: financialData,
                            color: {
                                up: '#00ff88',
                                down: '#ff4444',
                                unchanged: '#999'
                            },
                            borderColor: '#333',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const point = context.raw;
                                        return [
                                            `O: $${point.o.toFixed(2)}`,
                                            `H: $${point.h.toFixed(2)}`,
                                            `L: $${point.l.toFixed(2)}`,
                                            `C: $${point.c.toFixed(2)}`
                                        ];
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: getTimeUnit(timeframe),
                                    displayFormats: {
                                        minute: 'HH:mm',
                                        hour: 'MM-dd HH:mm',
                                        day: 'MM-dd'
                                    }
                                },
                                grid: { color: 'rgba(255,255,255,0.05)' },
                                ticks: { color: '#888', maxTicksLimit: 10 }
                            },
                            y: {
                                position: 'right',
                                grid: { color: 'rgba(255,255,255,0.05)' },
                                ticks: { 
                                    color: '#888',
                                    callback: function(value) {
                                        return '$' + value.toFixed(2);
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            console.log(`üìà Candlestick chart updated: ${financialData.length} candles (${timeframe})`);
        }
        
        function getTimeUnit(timeframe) {
            switch(timeframe) {
                case 'M1': return 'minute';
                case 'M5': return 'minute';
                case 'M15': return 'minute';
                case 'M30': return 'minute';
                case 'H1': return 'hour';
                case 'H4': return 'hour';
                default: return 'minute';
            }
        }
        
        // ========== DASHBOARD FUNCTIONS ==========
        function showWaitingMessage(type) {
            const waitingDiv = document.getElementById('waitingState');
            let html = '';
            
            switch(type) {
                case 'initial':
                    html = `
                        <div class="icon">‚ö°</div>
                        <h2>BB Scalper V4.2 Dashboard</h2>
                        <p>Initializing real-time monitoring...</p>
                        <div class="info-box">
                            <strong>Features Ready:</strong><br>
                            ‚Ä¢ Real-time candlestick charts<br>
                            ‚Ä¢ Multiple timeframe support<br>
                            ‚Ä¢ ML Engine monitoring<br>
                            ‚Ä¢ Performance analytics
                        </div>
                    `;
                    break;
                    
                case 'no_data':
                    html = `
                        <div class="icon">üì°</div>
                        <h2>Server Ready - Waiting for EA</h2>
                        <p>API server is online, waiting for EA to send data.</p>
                        
                        <div class="info-box">
                            <strong>Expected Data from EA:</strong><br>
                            ‚Ä¢ Symbol data to: /api/data<br>
                            ‚Ä¢ Candlestick data to: /api/chart<br>
                            ‚Ä¢ Timeframe: M1, M5, M15, M30, H1, H4<br>
                            ‚Ä¢ Auto-refresh every 3 seconds
                        </div>
                        
                        <button class="test-btn" onclick="testConnection()">
                            üîÑ Test Server Connection
                        </button>
                    `;
                    break;
                    
                case 'error':
                    html = `
                        <div class="icon">‚ùå</div>
                        <h2>Connection Error</h2>
                        <p>Cannot reach server. Check internet connection.</p>
                        <button class="test-btn" onclick="location.reload()">
                            üîÑ Reload Dashboard
                        </button>
                    `;
                    break;
                    
                default:
                    html = `
                        <div class="icon">ü§ñ</div>
                        <h2>BB Scalper V4.2 Dashboard</h2>
                        <p>Real-time trading monitor with candlestick charts</p>
                    `;
            }
            
            waitingDiv.innerHTML = html;
            waitingDiv.style.display = 'flex';
            document.getElementById('chartContainer').style.display = 'none';
        }
        
        async function testConnection() {
            const waitingDiv = document.getElementById('waitingState');
            waitingDiv.innerHTML = `
                <div class="icon">üîç</div>
                <h2>Testing Connection...</h2>
                <p>Checking server status...</p>
            `;
            
            try {
                const response = await fetch(API_BASE + 'ping');
                const data = await response.json();
                
                waitingDiv.innerHTML = `
                    <div class="icon">‚úÖ</div>
                    <h2>Server Connection OK!</h2>
                    <p>${data.message}</p>
                    <div class="info-box">
                        <strong>Server Status:</strong><br>
                        ‚Ä¢ Status: Online<br>
                        ‚Ä¢ Version: ${data.version}<br>
                        ‚Ä¢ Time: ${new Date().toLocaleTimeString()}<br>
                        ‚Ä¢ Active Symbols: ${data.active_symbols || 0}
                    </div>
                    <p>Waiting for EA to send trading data...</p>
                `;
                
            } catch (error) {
                waitingDiv.innerHTML = `
                    <div class="icon">‚ùå</div>
                    <h2>Connection Test Failed</h2>
                    <p>Error: ${error.message}</p>
                    <button class="test-btn" onclick="location.reload()">
                        üîÑ Retry
                    </button>
                `;
            }
        }
        
        function updateDashboard(data) {
            const symbols = data.symbols || {};
            const symbolKeys = Object.keys(symbols);
            const activeCount = symbolKeys.length;
            
            document.getElementById('activeCount').textContent = activeCount;
            
            if (activeCount > 0) {
                // Hide waiting, show chart
                document.getElementById('waitingState').style.display = 'none';
                document.getElementById('chartContainer').style.display = 'block';
                
                // Select first symbol if none selected
                if (!currentSymbol || !symbols[currentSymbol]) {
                    currentSymbol = symbolKeys[0];
                    console.log('üîç Selected symbol:', currentSymbol);
                }
                
                // Update symbol data
                if (currentSymbol && symbols[currentSymbol]) {
                    console.log('üìä Updating UI for:', currentSymbol);
                    updateSymbolData(symbols[currentSymbol]);
                }
                
                // Update symbol list
                updateSymbolList(symbols);
                
                console.log('‚úÖ Dashboard updated successfully!');
            } else {
                showWaitingMessage('no_data');
            }
        }
        
        function updateSymbolData(d) {
            // === BASIC INFO ===
            document.getElementById('chartSymbol').textContent = d.symbol || '--';
            document.getElementById('chartPrice').textContent = '$' + (d.bid || 0).toFixed(2);
            document.getElementById('chartSpread').textContent = 'Spread: ' + (d.spread || 0).toFixed(1);
            document.getElementById('chartVol').textContent = 'Vol: ' + (d.volatility || 'MEDIUM');
            
            // === ACCOUNT INFO ===
            const equity = parseFloat(d.equity) || 0;
            const dailyPnl = parseFloat(d.daily_pnl) || 0;
            const floating = parseFloat(d.floating) || 0;
            
            document.getElementById('equity').textContent = '$' + equity.toFixed(2);
            document.getElementById('equity').className = 'equity ' + (dailyPnl >= 0 ? 'positive' : 'negative');
            document.getElementById('headerEquity').textContent = '$' + equity.toFixed(0);
            document.getElementById('balance').textContent = '$' + (parseFloat(d.balance) || 0).toFixed(2);
            
            // Daily P/L
            const pnlEl = document.getElementById('dailyPnl');
            pnlEl.textContent = (dailyPnl >= 0 ? '+' : '') + '$' + dailyPnl.toFixed(2);
            pnlEl.className = 'account-value ' + (dailyPnl >= 0 ? 'positive' : 'negative');
            
            // Floating P/L
            const floatEl = document.getElementById('floating');
            floatEl.textContent = (floating >= 0 ? '+' : '') + '$' + floating.toFixed(2);
            floatEl.className = 'account-value ' + (floating >= 0 ? 'positive' : 'negative');
            
            // Commission
            document.getElementById('commission').textContent = '$' + (parseFloat(d.commission) || 0).toFixed(2);
            
            // === PERFORMANCE METRICS ===
            document.getElementById('totalTrades').textContent = d.total_trades || 0;
            document.getElementById('winRate').textContent = (d.win_rate || 0).toFixed(1) + '%';
            document.getElementById('wins').textContent = d.wins || 0;
            document.getElementById('losses').textContent = d.losses || 0;
            
            // === STATS & TIERS ===
            document.getElementById('sharpe').textContent = (d.sharpe || 0).toFixed(2);
            document.getElementById('profitFactor').textContent = (d.profit_factor || 0).toFixed(2);
            document.getElementById('expectancy').textContent = '$' + (d.expectancy || 0).toFixed(2);
            document.getElementById('tier1').textContent = 'T1: ' + (d.tier1 || 0);
            document.getElementById('tier2').textContent = 'T2: ' + (d.tier2 || 0);
            document.getElementById('tier3').textContent = 'T3: ' + (d.tier3 || 0);
            
            // === ML ENGINE ===
            const mlConf = parseFloat(d.ml_confidence) || 0;
            const mlEl = document.getElementById('mlConfidence');
            mlEl.textContent = mlConf.toFixed(0) + '%';
            mlEl.className = 'ml-value ' + (mlConf >= 70 ? 'high' : mlConf >= 50 ? 'medium' : 'low');
            
            document.getElementById('confluence').textContent = d.confluence || '0';
            document.getElementById('pattern').textContent = d.pattern || 'NONE';
            document.getElementById('volatility').textContent = d.volatility || 'MEDIUM';
        }
        
        function updateSymbolList(symbols) {
            const list = document.getElementById('symbolList');
            const keys = Object.keys(symbols);
            
            if (keys.length === 0) {
                list.innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">No active symbols</div>';
                return;
            }
            
            list.innerHTML = keys.map(sym => {
                const d = symbols[sym];
                const isActive = sym === currentSymbol;
                const priceChange = (d.daily_pnl || 0) >= 0 ? '‚Üó' : '‚Üò';
                const color = (d.daily_pnl || 0) >= 0 ? '#00ff88' : '#ff4444';
                
                return `
                    <div class="symbol-item ${isActive ? 'active' : ''}" 
                         onclick="selectSymbol('${sym}')">
                        <div>
                            <span style="font-weight: bold;">${sym}</span>
                            <span style="font-size: 11px; color: #888; margin-left: 5px;">
                                ${priceChange}
                            </span>
                        </div>
                        <span style="color: ${color}; font-weight: bold;">
                            $${(d.bid || 0).toFixed(2)}
                        </span>
                    </div>
                `;
            }).join('');
        }
        
        function selectSymbol(symbol) {
            currentSymbol = symbol;
            console.log('üéØ Selected symbol:', symbol);
            fetchData(); // Refresh data untuk simbol terpilih
        }
        
        function setConnected() {
            if (!isConnected) {
                isConnected = true;
                document.getElementById('connectionStatus').textContent = 'Connected';
                document.getElementById('connectionBox').className = 'status-item connected';
                document.getElementById('statusDot').className = 'dot green';
            }
        }
        
        function setDisconnected() {
            isConnected = false;
            document.getElementById('connectionStatus').textContent = 'Waiting...';
            document.getElementById('connectionBox').className = 'status-item disconnected';
            document.getElementById('statusDot').className = 'dot red';
        }
    </script>
</body>
</html>
